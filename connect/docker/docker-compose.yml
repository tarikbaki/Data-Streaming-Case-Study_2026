# Kafka Connect'i burada docker-compose ile ayaga kaldiriyorum.
# Tek node yeterli ama case icin 2 worker koydum. Plugin klasoru de burada.
# Bootstrap server ip'sini terraform output'tan alip buraya yaziyorum.

version: "3"

services:
  connect:
    image: confluentinc/cp-kafka-connect:7.6.0
    container_name: kafka-connect-1
    ports:
      - "8083:8083"
      - "7777:7777"
    environment:
      CONNECT_BOOTSTRAP_SERVERS: "192.168.56.10:9092"
      CONNECT_REST_PORT: 8083
      CONNECT_GROUP_ID: "connect-cluster"
      CONNECT_CONFIG_STORAGE_TOPIC: "connect-configs"
      CONNECT_OFFSET_STORAGE_TOPIC: "connect-offsets"
      CONNECT_STATUS_STORAGE_TOPIC: "connect-status"
      CONNECT_KEY_CONVERTER: "org.apache.kafka.connect.json.JsonConverter"
      CONNECT_VALUE_CONVERTER: "org.apache.kafka.connect.json.JsonConverter"
      CONNECT_REST_ADVERTISED_HOST_NAME: "kafka-connect-1"
      CONNECT_PLUGIN_PATH: "/usr/share/java"
      CONNECT_JMX_PORT: "7777"
      KAFKA_OPTS: "-javaagent:/jmx-exporter/jmx_prometheus_javaagent-0.20.0.jar=7777:/jmx-exporter/connect.yml -Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.local.only=false -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.ssl=false -Dcom.sun.management.jmxremote.port=7777"
      CONNECT_SECURITY_PROTOCOL: "PLAINTEXT"
#      CONNECT_SASL_MECHANISM: "SCRAM-SHA-512"
#      CONNECT_SASL_JAAS_CONFIG: "org.apache.kafka.common.security.scram.ScramLoginModule required username=\"broker\" password=\"brokerpass\";"
      CONNECT_CONFIG_STORAGE_REPLICATION_FACTOR: 3
      CONNECT_OFFSET_STORAGE_REPLICATION_FACTOR: 3
      CONNECT_STATUS_STORAGE_REPLICATION_FACTOR: 3
    volumes:
      - ./plugins:/usr/share/java
      - ./jmx-exporter:/jmx-exporter:ro

  connect2:
    image: confluentinc/cp-kafka-connect:7.6.0
    container_name: kafka-connect-2
    ports:
      - "8084:8083"
      - "7778:7777"
    environment:
      CONNECT_BOOTSTRAP_SERVERS: "192.168.56.10:9092"
      CONNECT_REST_PORT: 8083
      CONNECT_GROUP_ID: "connect-cluster"
      CONNECT_REST_ADVERTISED_HOST_NAME: "kafka-connect-2"
      CONNECT_PLUGIN_PATH: "/usr/share/java"
      CONNECT_JMX_PORT: "7777"
      KAFKA_OPTS: "-javaagent:/jmx-exporter/jmx_prometheus_javaagent-0.20.0.jar=7777:/jmx-exporter/connect.yml -Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.local.only=false -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.ssl=false -Dcom.sun.management.jmxremote.port=7777"
      CONNECT_SECURITY_PROTOCOL: "PLAINTEXT"
#      CONNECT_SASL_MECHANISM: "SCRAM-SHA-512"
#      CONNECT_SASL_JAAS_CONFIG: "org.apache.kafka.common.security.scram.ScramLoginModule required username=\"broker\" password=\"brokerpass\";"
      CONNECT_CONFIG_STORAGE_REPLICATION_FACTOR: 3
      CONNECT_OFFSET_STORAGE_REPLICATION_FACTOR: 3
      CONNECT_STATUS_STORAGE_REPLICATION_FACTOR: 3
    volumes:
      - ./plugins:/usr/share/java
      - ./jmx-exporter:/jmx-exporter:ro
